# テストコーディング規約

このドキュメントは、SelectedPageTextServiceのテスト作成・修正経験から得られたテストコーディングのベストプラクティスを定義します。

## テストルール

### テストファイル構造
- **テストファイルは必ず対応する実装ファイルと同じディレクトリ構造を持つこと**
- **単体テストは、1メソッドごとに1ファイル以上にすること**
  - クラス単位でまとめない
  - 1メソッドでもあっても、ケースの内容や量によっては、適切に複数ファイルに分割すること

### 実装時の必須チェック
- **追加、変更があったメソッドには必ず単体テストを追加**
- **PRレビュー前に必ず`make testcheck`を実行して通ることを確認**

# 共通ルール

全ての層のテストに適用される共通の規約です。

## 1. テストケースの統合と効率化

### 1.1 冗長なテストの統合原則
入力値パターンが同じで済むものについては、まずは1つのテストにまとめる：

```typescript
// ❌ 悪い例：冗長な個別テスト
it('should call chrome.storage API correctly', () => { /* ... */ });
it('should resolve successfully', () => { /* ... */ });
it('should return Promise type', () => { /* ... */ });

// ✅ 良い例：統合されたテスト
it('should correctly call chrome.storage API, resolve successfully, and return Promise', async () => {
  // Promise型確認、API呼び出し確認、結果確認を統合
});
```

## 3. モックとテストセットアップ

### 3.1 beforeEach/afterEach の使用
```typescript
beforeEach(() => {
  service = new SelectedPageTextService();
  vi.clearAllMocks();  // 呼び出し履歴をクリア
});

afterEach(() => {
  vi.resetAllMocks();  // モックの実装をリセット
});
```

### 3.2 モック設定の原則
- グローバルなモックは統一的に設定
- テスト間でモック状態が漏れないよう適切にクリーンアップ
- モックの役割を明確にコメントで記述

## 4. バリデーションテスト

- サブクラスでバリデーションを実装している場合、そのバリデーションの返り値のパターン(異常値含む)だけ網羅できれば良い
  - 言い換えると、バリデーションの詳細なロジックはサブクラスのテストで網羅されているため、親クラスではバリデーションの結果に基づく動作のみをテストすれば良い



# Clean Architecture用ルール

Clean Architectureの各層に特化したテスト規約です。

## 各層共通の規約

### 1. テストファイル構造とディレクトリ構成

#### 1.1 ディレクトリ構造の原則
```
tests/unit/[layer]/[category]/[service-name]/
├── [method-name]/
│   ├── normal-cases.test.ts         # 正常系テスト
│   └── Abend/                       # 異常系テスト専用ディレクトリ
│       └── error-cases.test.ts      # エラーケース
```

#### 1.2 異常系テストの分離原則
- `Abend/` ディレクトリに異常系テストを分離
- 外部システム依存の異常ケースを重点的にテスト
- 正常系と異常系の明確な区分
- 異常系内でもケース別にファイルを分割

## infrastructure層固有の規約

### 1. Infrastructure層特有のパターン
- Infrastructure層は、下記のクラスのみテストコードを作成する。
  - di
  - persistance
上記のクラスは、クラスの作成、変更時にテストコードを作成、変更する。またエラー系のテストコードは必須としない
それ以外のクラスは、必須とせず、必要に応じて作成する。