# Issueの計画

## 問題の概要
ルールを編集した後、該当するタブへのルール再適用がうまく行っていない問題を修正する。

## 実装方針（更新版）
1. ~~現在のルール再適用の仕組みを調査~~ ✅ 完了
2. ~~タブリロード処理の問題箇所を特定~~ ✅ DOM走査範囲の問題と判明
3. **方針転換**: タブリロード → DOM走査改善へ
   - `ApplySavedRulesOnPageLoadUseCase` のDOM走査範囲拡大
   - 強制リスキャン機能の実装
4. テスト追加とE2Eテストでの検証

# DAILY-SCRUM単位のタスク
- [x] **調査フェーズ**: 現在のルール適用・タブリロード処理の実装調査 ✅ 完了
  - コンテンツスクリプトでのルール適用処理の確認
  - バックグラウンドスクリプトでのタブ管理処理の確認
  - ルール編集時のイベントフローの確認
- [x] **問題特定フェーズ**: ルール再適用が失敗する原因の特定 ✅ 完了
  - ルール変更イベントの伝播確認
  - タブへの通知処理の確認
  - ~~タイミング問題やライフサイクル問題の調査~~ → 設計上の根本問題と判明
- [x] **修正実装フェーズ1**: DOM走査改善の実装 ✅ 完了
  - ~~DOM走査範囲の拡大~~ → head要素削除問題が発生するため断念
  - `document.body`での走査に戻してhead要素削除を防止 ✅ 完了
  - ルール編集問題は設計上の根本課題として別解決策へ
- [x] **修正実装フェーズ2**: タブリロード機能実装 ✅ 完了
  - `IChromeTabsService`インターフェースに`reloadTab()`メソッド追加 ✅ 完了
  - `ChromeTabsService`でChrome Tabs API実装 ✅ 完了
  - `UpdateRewriteRuleUseCase`でタブリロード処理統合 ✅ 完了
- [x] **デバッグ・修正フェーズ**: プロトコルエラー解決 ✅ 完了
  - デバッグログ追加による問題特定 ✅ 完了
  - Chrome関連URLプロトコルサポート追加 ✅ 完了
  - `TabUrl`クラスでのプロトコル検証改善 ✅ 完了
- [x] **テスト・品質保証フェーズ**: 修正内容の検証 ✅ 完了
- [ ] 編集ボタン保存を押下した際に、該当タブが正しくリロードされ、ルールが適用されることを確認するe2eテストを追加(既存のテストで代替できるかも確認)
  - 新機能のユニットテスト追加・更新 ✅ 完了（265件すべて通過）
  - 既存E2Eテストでの回帰テスト ✅ 完了（9件すべて通過）
  - コード品質チェック完了 ✅ 完了（lint・knip・tsr すべて問題なし）

# ISSUEを通した相談事
- ルール適用の仕組みについて、現在の実装でChrome拡張機能のライフサイクルやメッセージパッシングが適切に行われているか確認が必要
- タブのリロード処理で、ユーザー体験を損なわない適切なタイミングでの更新方法を検討したい

# 残タスク
<!-- issueの進捗に応じて記入 -->