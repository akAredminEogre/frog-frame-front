# Issue-013 実装計画: span要素の右クリック置換不具合修正

## 問題分析

### 現在の問題
- span要素内のテキスト（`商品番号：`）を右クリック置換する際
- 期待値：`<span class="inline-flex">商品番号：</span>`
- 実際値：`商品番号：`（テキストのみ）

### 根本原因
`ElementSelector.getElementFromSelection()`の処理において、以下の問題が考えられる：

1. **複数テキストノードの問題**
   ```html
   <span class="inline-flex">
     "商品番号"    <!-- テキストノード1 -->
     "："            <!-- テキストノード2 -->
   </span>
   ```
   span要素内に2つのテキストノードが存在する場合、選択範囲の共通祖先の特定が不適切

2. **選択範囲の処理ロジック**
   現在のロジックでは、右クリック時の選択範囲（通常は単語レベル）から適切な要素を特定できていない

## 実装方針

### 1. ElementSelectorクラスの修正
現在の`getElementFromSelection()`メソッドを改善し、以下の処理を追加：

1. **右クリック時の選択範囲処理の改善**
   - 右クリック時は選択範囲が狭い場合が多い
   - 選択範囲からその要素を含む最小のHTML要素を特定する処理を強化

2. **親要素の遡及処理**
   - テキストノードの親要素がspan等のインライン要素の場合
   - より適切な要素まで遡及する処理を追加

3. **複数テキストノード対応**
   - span要素内の複数テキストノードをまたぐ選択に対応

### 2. 具体的な修正内容

#### ElementSelector.tsの修正点：

1. **`getElementFromSelection()`メソッドの強化**
   ```typescript
   // 追加予定の処理：
   // - 選択範囲が狭い場合の親要素遡及処理
   // - span等のインライン要素の適切な検出
   // - 複数テキストノード対応
   ```

2. **新メソッドの追加**
   ```typescript
   // 候補メソッド：
   // - findContainingElement(): 選択テキストを含む適切な要素を特定
   // - isTargetElement(): 要素が置換対象として適切かの判定
   ```

### 3. テストケースの追加

#### 単体テストの拡充
`ElementSelector.test.ts`に以下のテストケースを追加：

1. **span要素内複数テキストノードのテスト**
2. **右クリック時の狭い選択範囲のテスト**
3. **インライン要素の適切な検出テスト**

#### 期待する動作のテストケース：
```typescript
describe('span要素内の右クリック置換', () => {
  it('span要素内の複数テキストノードを右クリックした場合、span要素全体を取得する', () => {
    // テスト実装
  });
});
```

## 実装スケジュール

### Phase 1: 調査・分析 (完了)
- [x] 問題の特定
- [x] 現在のコードの分析
- [x] 根本原因の特定

### Phase 2: 実装
1. **ElementSelector.tsの修正**
   - `getElementFromSelection()`メソッドの改善
   - 親要素遡及処理の追加
   - 複数テキストノード対応

2. **テストケースの追加**
   - 単体テスト拡充
   - 新しい不具合ケースのテスト

### Phase 3: 検証
1. **手動テスト**
   - 実際のHTML環境での動作確認
   - Issue記載のユースケースでの検証

2. **自動テスト**
   - 既存テストの通過確認
   - 新規テストの通過確認

## 受け入れ条件の対応

- [ ] **期待する動作の実現**: span要素内のテキストを右クリックした際、span要素全体が取得される
- [ ] **単体テストの作成**: 新しいケースに対応するテストケースの作成と通過
- [ ] **既存テストの維持**: 既存のユニットテスト、e2eテストが通る

## 技術的考慮事項

### 1. 影響範囲
- `ElementSelector.ts`: メイン修正対象
- `ElementSelector.test.ts`: テスト追加
- `content.ts`: 呼び出し側への影響確認

### 2. 後方互換性
- 既存の動作を破壊しないよう注意
- 既存のテストケースが全て通ることを確認

### 3. エッジケース
- ネストしたspan要素
- 空のspan要素
- span要素以外のインライン要素

## リスク要因

### 1. 技術的リスク
- 選択範囲APIの複雑性
- ブラウザ間の動作差異

### 2. 対策
- 十分なテストケースでの検証
- 段階的な実装と検証
