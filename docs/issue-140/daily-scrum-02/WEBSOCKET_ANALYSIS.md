# WebSocket接続エラーの根本原因分析

## 質問
> 本issueのドメイン層のコード修正でWebSocket接続エラーが発生した理由を分析してください。

## 分析結果

### 結論：ドメイン層のコード修正は直接的にはWebSocket接続エラーの原因ではない

**技術的根拠**:

1. **Clean Architectureの原則違反はない**
   - ドメイン層は純粋なビジネスロジックのみを含んでいる
   - Chrome API、WebSocket、外部依存性は一切含まれていない
   - アーキテクチャ原則に従い、インフラストラクチャ層との依存関係が正しく分離されている

2. **WebSocket接続の実際の発生場所**
   - WXT開発サーバー（.output/chrome-mv3-dev）の Hot Reload 機能
   - 開発時のファイル変更検知システム
   - 拡張機能とWXTツールチェーン間の通信

3. **問題の真の原因**
   - **開発ビルド固有の問題**: WXT開発サーバーのWebSocket接続が不安定
   - **本番ビルドでは正常**: WebSocket依存がない静的ビルドでは問題なし
   - **インフラストラクチャ層の問題**: ドメイン層とは無関係

### なぜドメイン層の修正と同時期に発生したか

**間接的な因果関係**:

1. **開発サイクルの影響**
   - ドメイン層の大量修正 → ファイル変更検知の頻発
   - WXT開発サーバーの負荷増加
   - WebSocket接続の不安定化

2. **E2Eテスト実行環境の変化**
   - 新しいドメインロジック（CSS括弧エスケープ）のテスト追加
   - より複雑なDOM操作の実行
   - 開発ビルドでの不安定性が表面化

3. **タイミングの問題**
   - ドメイン層修正完了時点でE2Eテスト実行
   - 開発サーバーのWebSocket接続問題が同時期に顕在化
   - 因果関係の誤認

### 技術的解決策の妥当性

**本番ビルド使用への切り替え**:
- WebSocket依存の完全排除
- 静的ファイルによる安定した拡張機能動作
- ドメインロジックの正確なテスト実行

## 教訓

1. **Clean Architectureの重要性**
   - ドメイン層の純粋性により、インフラ問題の影響を受けない
   - 適切な責任分離により問題の切り分けが可能

2. **開発環境と本番環境の差異**
   - 開発ツールの依存性（WebSocket等）は本番環境にない
   - E2Eテストは本番に近い環境で実行すべき

3. **因果関係の正確な分析**
   - 時系列の一致と真の因果関係は異なる
   - アーキテクチャ原則に基づく分析が重要