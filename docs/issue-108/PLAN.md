# Issueの計画

## 問題の分析

### エラーの原因
現在、`tabs.onUpdated`リスナー（`src/infrastructure/browser/listeners/tabs.onUpdated.ts:15`）が全てのタブに対して`sendApplyAllRulesMessage`を呼び出していますが、以下の理由でエラーが発生しています:

1. **コンテンツスクリプトの注入制限**: `content.ts`はマニフェストの`matches`パターンに一致するページにのみ注入されます
2. **chrome://ページへの注入不可**: `chrome://extensions/`などのchrome:// URLにはコンテンツスクリプトを注入できません（Chromeの仕様）
3. **エラーハンドリングの不足**: 現在の実装では`.catch(() => {})`でエラーを握りつぶしているものの、コンソールには`ChromeTabsService.ts:43`でエラーログが出力されています

### 現在のコード
```typescript
// tabs.onUpdated.ts:15
chromeTabsService.sendApplyAllRulesMessage(currentTab).catch(() => {
  /* コンテンツスクリプト未注入時のエラーは無視 */
});
```

問題点:
- `ChromeTabsService.sendApplyAllRulesMessage`内でエラーログを出力後にthrowしているため、catchの前にエラーログが表示される
- コンテンツスクリプトが注入できないURLに対してメッセージ送信を試みている

## 受け入れ条件

1. chrome://extensions/やchrome://などのURLでエラーログが出力されないこと
2. 通常のウェブページでは引き続き正常にルールが適用されること
3. 既存のテストが全て合格すること

## 解決方針

### アプローチ1: メッセージ送信前にURLをフィルタリング（推奨）
`tabs.onUpdated.ts`でメッセージを送信する前に、対象URLがコンテンツスクリプト注入可能かチェックする

**利点**:
- 不要なメッセージ送信を防げる
- エラーログが出力されない
- パフォーマンスが向上

**欠点**:
- URLパターンマッチングロジックが必要

### アプローチ2: ChromeTabsServiceでエラーログを抑制
`sendApplyAllRulesMessage`メソッドで特定のエラー（"Receiving end does not exist"）の場合はログ出力しない

**利点**:
- 実装が簡単

**欠点**:
- 無駄なメッセージ送信が発生する
- 他の正当なエラーと区別する必要がある

## DAILY-SCRUM単位のタスク

### DAILY-SCRUM 01: 調査と設計
- [ ] コンテンツスクリプト注入可能なURLパターンの調査
  - WXTフレームワークのmatchesパターンの仕様確認
  - chrome://、about://、file://などの特殊URLの動作確認
- [ ] 既存の関連コードの調査
  - `matchUrl.ts`の実装確認
  - 他のメッセージ送信箇所での同様の問題の有無確認
- [ ] 解決アプローチの決定と設計
  - アプローチ1とアプローチ2の詳細比較
  - URLフィルタリングロジックの設計（アプローチ1の場合）

### DAILY-SCRUM 02: 実装
- [ ] URLフィルタリング機能の実装
  - `domain/value-objects/`または`domain/entities/`にURL判定ロジック追加
  - 注入可能URLパターンのホワイトリスト/ブラックリスト定義
- [ ] `tabs.onUpdated.ts`の修正
  - URLフィルタリングを適用
  - 適切なエラーハンドリング追加
- [ ] `ChromeTabsService`の改善（必要に応じて）
  - エラーログの最適化
  - エラー種別の分類

### DAILY-SCRUM 03: テストとドキュメント
- [ ] ユニットテストの追加/更新
  - URLフィルタリングロジックのテスト
  - `tabs.onUpdated`のテスト
  - エラーハンドリングのテスト
- [ ] E2Eテストの確認
  - chrome://ページでのエラー発生確認
  - 通常ページでのルール適用確認
- [ ] 既存テストの実行と修正
  - `make test-and-lint`の実行
  - 失敗するテストの修正
- [ ] ドキュメント更新（必要に応じて）

## ISSUEを通した相談事
<!-- 相談したいこと、質問したいこと、レビューしてほしいこと -->
<!-- について、体言止めでの相談ではなににどう答えればよいのか明確にならないので使わないでください-->
<!-- 相談は具体的な内容を記載してください。 -->
<!-- 質問は不明点を明確に記載してください。 -->
<!-- レビューしてほしいことは、レビュー対象を具体的に記載してください。 -->
<!-- また上記相談・質問・レビューのトピックが重複する場合は、まとめて記載してください。 -->

## 残タスク
<!-- issueの進捗に応じて記入 -->
