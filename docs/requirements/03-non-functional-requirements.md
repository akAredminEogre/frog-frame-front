# 非機能要件定義書

## セキュリティ要件

### データ保護
- **データ保存場所:** すべてローカル（chrome.storage.local、chrome.storage.sync）
- **外部送信:** ユーザーデータの外部送信は一切行わない
- **暗号化:** 設定データは平文（機密情報なし）
- **アクセス制御:** 拡張機能内でのみデータアクセス可能

### 権限管理
| 権限 | 必要性 | セキュリティ影響 | 軽減策 |
|-----|-------|---------------|--------|
| storage | 必須 | 低 | データは全てローカル |
| activeTab | 必須 | 中 | アクティブタブのみアクセス |
| scripting | 必須 | 高 | 最小限のスクリプト注入、CSP準拠 |

### Content Security Policy準拠
- **インラインスクリプト:** 全面禁止
- **eval()関数:** 使用禁止
- **外部スクリプト:** 読み込み禁止
- **動的コード生成:** 禁止

### XSS対策
- **HTML挿入時:** DOMPurifyによるサニタイゼーション
- **ユーザー入力:** 全てエスケープ処理
- **スクリプト実行:** 信頼できるコンテキストのみ

### 第三者サイトへの影響
- **非破壊的操作:** 元のページへの永続的変更なし
- **パフォーマンス影響:** ページ表示速度への影響最小化
- **互換性:** 既存のJavaScriptとの競合回避

## ユーザビリティ要件

### アクセシビリティ
- **WCAG 2.1 AA準拠:** 全UI要素でクリア
- **キーボード操作:** 全機能をキーボードのみで操作可能
- **スクリーンリーダー対応:** aria-labelとrole属性の適切な設定
- **カラーコントラスト比:** 4.5:1以上（通常テキスト）、3:1以上（大きなテキスト）
- **フォーカス表示:** 視覚的に明確なフォーカスインジケーター

### 多言語対応
- **対応言語:** 日本語、英語（初期リリース）
- **国際化実装:** chrome.i18n APIを使用
- **言語切り替え:** 設定画面から変更可能
- **文字エンコーディング:** UTF-8のみ

### レスポンシブデザイン
- **拡張機能ポップアップ:** 固定サイズ（400x600px）
- **設定画面:** ブラウザウィンドウサイズに対応
- **画面解像度:** 1024x768以上で最適化
- **ダークモード対応:** システム設定に追従 + 手動切り替え

### エラーメッセージ
- **言語:** ユーザーの設定言語で表示
- **内容:** 具体的で理解しやすい説明
- **回復手段:** 可能な場合は回復方法を提示
- **ログ記録:** デバッグ用の詳細ログ（オプトイン）

## 互換性要件

### ブラウザサポート
| ブラウザ | 最小バージョン | 備考 |
|---------|-------------|------|
| Google Chrome | 120 | メインターゲット |
| Microsoft Edge | 120 | Chromiumベース |
| Brave Browser | 1.60 | Chromiumベース |

**サポート対象外:**
- Firefox（Manifest V3対応が不完全）
- Safari（Web Extensions API制限）
- 古いChromium系ブラウザ（セキュリティリスク）

### OS互換性
- **Windows:** Windows 10以降（Chrome対応範囲）
- **macOS:** macOS 10.15以降（Chrome対応範囲）
- **Linux:** Ubuntu 18.04以降、その他主要ディストリビューション
- **Chrome OS:** 全バージョン対応

### Manifest V3要件
- **Service Worker:** background.js のService Worker化
- **Host Permissions:** 最小権限の原則
- **Content Security Policy:** 厳格なCSP適用
- **Dynamic Import:** 動的インポート対応

### 後方互換性
- **設定データ:** マイナーバージョンアップ時は互換性維持
- **操作履歴:** フォーマット変更時はマイグレーション提供
- **保存ファイル:** バージョン情報付きで将来対応

## 信頼性要件

### 可用性
- **ターゲット稼働率:** 99.9%（ブラウザが動作している限り）
- **ダウンタイム:** ブラウザ再起動・拡張機能更新時のみ
- **自動復旧:** クラッシュ後の自動再起動対応

### エラーハンドリング
```typescript
// エラー分類と対応
enum ErrorLevel {
  FATAL = 'fatal',      // 機能停止、データ損失リスク
  ERROR = 'error',      // 操作失敗、機能は継続
  WARNING = 'warning',  // 軽微な問題、ユーザー注意
  INFO = 'info'         // 情報提供のみ
}
```

### エラー対応方針
| エラーレベル | 表示方法 | 記録 | ユーザー操作 |
|------------|---------|------|-------------|
| FATAL | モーダルダイアログ | 必須 | 拡張機能再起動 |
| ERROR | トーストメッセージ | 必須 | 再試行可能 |
| WARNING | インラインメッセージ | 推奨 | 続行可能 |
| INFO | サブテキスト | 任意 | 通知のみ |

### データ整合性
- **操作の原子性:** UNDO/REDOスタックの整合性保証
- **データバックアップ:** 設定・履歴の定期バックアップ
- **破損データ検知:** 起動時のデータ検証
- **自動修復:** 可能な範囲での自動データ修復

### フォールトトレラント
- **単一操作失敗:** 他の操作に影響なし
- **メモリ不足:** グレースフルデグラデーション
- **DOM変更競合:** 他スクリプトとの競合回避
- **ネットワーク遮断:** 完全オフライン動作

## パフォーマンス最適化

### メモリ管理
- **ガベージコレクション:** 未使用オブジェクトの適切な解放
- **メモリリーク防止:** イベントリスナーの適切なクリーンアップ
- **WeakMap使用:** DOM要素参照での循環参照回避

### DOM操作最適化
- **バッチ処理:** 複数変更の一括実行
- **DocumentFragment使用:** 大量要素作成時
- **CSSクラス操作優先:** インラインスタイルより高速

### レンダリング最適化
- **Reflow/Repaint最小化:** レイアウト変更の最適化
- **transform/opacity使用:** GPUアクセラレーション活用
- **Intersection Observer:** 要素表示状態の効率的監視

## 保守性要件

### コード品質
- **TypeScript strict mode:** 厳密な型チェック
- **ESLint:** コーディング規約の自動チェック
- **Prettier:** コードフォーマットの統一
- **テストカバレッジ:** 80%以上

### アーキテクチャ要件
- **Clean Architecture:** レイヤー分離の徹底
- **Dependency Injection:** tsyringeコンテナ使用
- **Single Responsibility Principle:** 単一責任の原則
- **Interface Segregation:** インターフェース分離

### ドキュメント要件
- **JSDoc:** 全public APIにコメント
- **README.md:** セットアップ・使用方法
- **CONTRIBUTING.md:** 開発者向けガイド
- **CHANGELOG.md:** 変更履歴の管理

### 更新性
- **自動更新:** Chrome標準の自動更新機能
- **バージョニング:** セマンティックバージョニング
- **マイグレーション:** データフォーマット変更時の移行機能
- **ロールバック:** 問題発生時の前バージョン復帰

## テスト要件

### テストレベル
| テストタイプ | カバレッジ目標 | ツール | 実行タイミング |
|------------|-------------|--------|-------------|
| ユニットテスト | 80% | Vitest | 開発時・CI/CD |
| 統合テスト | 主要フロー100% | Vitest | CI/CD |
| E2Eテスト | クリティカルパス100% | Playwright | リリース前 |
| パフォーマンステスト | - | Lighthouse | 手動実行 |
| セキュリティテスト | - | 静的解析ツール | リリース前 |

### テスト環境
- **ブラウザ:** Chrome最新版、Chrome最新版-2
- **OS:** Windows、macOS、Linux（主要ディストリビューション）
- **CI/CD:** GitHub Actions
- **パフォーマンス測定:** Lighthouse CI

### テスト自動化
- **PRチェック:** ユニット・統合テスト必須
- **リリースチェック:** E2Eテスト必須
- **パフォーマンス監視:** 継続的なメトリクス収集

## コンプライアンス要件

### プライバシー
- **データ収集:** ユーザーデータは収集しない
- **使用統計:** 匿名統計のみ（オプトイン）
- **プライバシーポリシー:** Chrome Web Store要件準拠
- **GDPR対応:** データ処理の透明性確保

### ライセンス
- **ソースコード:** MITライセンス
- **依存ライブラリ:** ライセンス互換性確認済み
- **商標:** 第三者商標の侵害なし
- **オープンソース:** GitHub公開

### Chrome Web Storeポリシー
- **単一目的:** DOM操作ツールとしての明確な目的
- **権限の正当性:** 最小限の権限要求
- **プライバシー開示:** データ使用の透明性
- **品質基準:** 安定動作とユーザー価値の提供

### セキュリティ基準
- **OWASP Top 10:** Web脆弱性対策
- **CSP Level 3:** Content Security Policy準拠
- **SRI:** Subresource Integrity実装（該当する場合）
- **定期監査:** 脆弱性スキャンの実施

## 運用要件

### 監視・ログ
- **エラーログ:** クライアントサイドエラーの記録
- **使用統計:** 匿名使用パターンの分析（オプトイン）
- **パフォーマンスメトリクス:** 応答時間・リソース使用量

### サポート
- **ユーザーサポート:** GitHub Issues
- **ドキュメント:** 使用方法のオンラインヘルプ
- **FAQ:** よくある質問の整備
- **フィードバック:** ユーザーフィードバックの収集

### 更新・リリース
- **リリースサイクル:** 月1回のメンテナンスリリース
- **緊急対応:** セキュリティ問題は24時間以内
- **バックアップ:** 設定・データの自動バックアップ機能