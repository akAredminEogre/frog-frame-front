# Issue-027 実装計画: 右クリック時のテーブルDOM選択の修正

## 概要
テーブル内のテキスト選択時に、`table`全体ではなく`tr`要素が選択されるように`ElementSelector`クラスを修正する。

## 問題の詳細
現在、テーブル内の`商品番号：moge-1234`のようなテキストを選択して右クリックすると、`table`要素全体が選択対象となってしまう。本来は`tr`要素が選択されるべき。

### 現在の動作
```html
<!-- 現在選択される範囲 -->
<table class="hoge">
  <tbody>
    <tr>
      <th><span>"商品番号""："</span></th>
      <td><span>moge-1234</span></td>
    </tr>
  </tbody>
</table>
```

### 期待される動作
```html
<!-- 期待される選択範囲 -->
<tr>
  <th><span>"商品番号""："</span></th>
  <td><span>moge-1234</span></td>
</tr>
```

## 根本原因
`ElementSelector.ts`の`isSuitableAsTarget`メソッドで、テーブル関連要素に対する適切な処理がない。現在は以下の優先順位で要素を選択している：
1. インライン要素（span, a, strong等）
2. 属性を持つ要素

この結果、`table`要素が`class`属性を持っているため、適切なターゲットとして判定されてしまう。

## 実装方針

### 1. テーブル要素用の判定ロジック追加
`isSuitableAsTarget`メソッドにテーブル関連要素（`tr`, `td`, `th`, `tbody`, `thead`, `tfoot`）の判定ロジックを追加し、これらの要素を優先的に選択するようにする。

### 2. テーブル要素の優先順位設定
テーブル内での要素選択時の優先順位：
1. `tr` 要素（最優先）
2. `td`, `th` 要素
3. `tbody`, `thead`, `tfoot` 要素
4. 既存のインライン要素
5. 属性を持つ要素

### 3. テーブル構造の判定
選択範囲がテーブル内にあるかどうかを判定し、テーブル内の場合は専用のロジックを適用する。

## 実装ステップ

### Phase 1: 実装
1. **テーブル要素判定メソッドの追加**
   - `isTableElement(element: Element): boolean`メソッドを追加
   - テーブル関連要素を判定するロジックを実装

2. **選択範囲テーブル判定メソッドの追加**
   - `isWithinTable(element: Element): boolean`メソッドを追加
   - 要素がテーブル内にあるかを判定するロジックを実装

3. **isSuitableAsTargetメソッドの修正**
   - テーブル内の場合の特別処理を追加
   - テーブル要素の優先順位に基づく判定ロジックを実装

4. **findTargetElementメソッドの修正**
   - テーブル内での探索時は`table`要素で停止するように修正

### Phase 2: テスト実装
1. **単体テストの作成**
   - テーブル内テキスト選択時の動作テスト
   - 新しく追加したメソッドのテスト
   - 既存機能への影響確認テスト

2. **テストケース**
   ```typescript
   // テーブル内選択のテストケース
   describe('テーブル内要素選択', () => {
     it('テーブル内のspanテキスト選択時にtr要素が返される', () => {
       // テスト実装
     });
     
     it('複数のtr要素にまたがる選択時に適切な共通祖先が返される', () => {
       // テスト実装  
     });
     
     it('テーブル外の要素選択時は既存ロジックが動作する', () => {
       // テスト実装
     });
   });
   ```

### Phase 3: 品質確認
1. **Lintチェック**
   - `npm run lint`でコードスタイルの確認

2. **未使用コードチェック**
   - `npm run unused:check`で不要なコードがないことを確認

3. **既存テストの実行**
   - 既存の単体テスト、e2eテストがパスすることを確認

## 修正対象ファイル
- `src/domain/entities/ElementSelector.ts`
  - メソッド追加: `isTableElement`, `isWithinTable`
  - メソッド修正: `isSuitableAsTarget`, `findTargetElement`

## テストファイル
- `src/domain/entities/__tests__/ElementSelector.test.ts`
  - テーブル関連のテストケース追加

## 受け入れ条件
- [x] テーブル内のテキスト選択時に`tr`要素が選択される
- [x] 新機能の単体テストが実装されている
- [x] `npm run lint`、`npm run unused:check`でエラーが出ない
- [x] 既存の単体テスト、e2eテストがすべてパスする
- [x] テーブル外の要素選択動作に影響がない

## リスク・制約事項
- 既存のDOM選択ロジックへの影響を最小限に抑える必要がある
- 複雑なネストしたテーブル構造での動作確認が必要
- 他のDOM構造（divベースのテーブル風レイアウト）への影響確認が必要

## 実装時間見積り
- Phase 1: 4時間
- Phase 2: 3時間  
- Phase 3: 1時間
- **合計: 8時間**
