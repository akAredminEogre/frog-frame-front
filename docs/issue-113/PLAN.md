# Issueの計画

# DAILY-SCRUM単位のタスク
- ISSUE.mdを元に、開発タスクをデイリースクラム単位に分解する
- [x] IndexedDB環境検証テストの実装
  - テスト環境でIndexedDBが実際に使用されていることを確認するテストを追加
  - fake-indexeddbが正しくセットアップされているか検証
  - Dexieインスタンスが正常に初期化されるか検証
  - テストが失敗した場合のエラーメッセージを改善し、環境セットアップの問題を早期検知できるようにする

# ISSUEを通した相談事
<!-- 相談したいこと、質問したいこと、レビューしてほしいこと -->
<!-- について、体言止めでの相談ではなににどう答えればよいのか明確にならないので使わないでください-->
<!-- 相談は具体的な内容を記載してください。 -->
<!-- 質問は不明点を明確に記載してください。 -->
<!-- レビューしてほしいことは、レビュー対象を具体的に記載してください。 -->
<!-- また上記相談・質問・レビューのトピックが重複する場合は、まとめて記載してください。 -->

## Vitestのhappy-dom環境で「実際のIndexedDB」を使用する方法について相談したい

現在のDexieRewriteRuleRepositoryのユニットテストは`fake-indexeddb`を使用していますが、ISSUE.mdでは「実際のIndexedDB」を使用するように変更することが求められています。

しかし、Vitestのユニットテスト環境（happy-dom）では、ブラウザの実際のIndexedDB APIは利用できません。以下の選択肢が考えられます：

### 選択肢1: fake-indexeddbを継続使用（現状維持）
- `fake-indexeddb`は実際のIndexedDB APIの仕様に準拠した実装を提供
- 既にテストは実際のDexie APIを使用している（`dexieDatabase.rewriteRules.clear()`等）
- モックではなく、IndexedDBの完全な実装を提供している

### 選択肢2: E2Eテストへの移行
- Playwrightを使用して実際のブラウザ環境でテスト
- 本物のIndexedDBを使用できる
- ただし、テストの実行速度が遅くなり、ユニットテストの粒度が失われる

### 選択肢3: 環境をjsdomやhappier-domに変更
- 他のDOM環境を試すが、いずれもユニットテストレベルでは実際のIndexedDBは提供されない

### 質問
1. ISSUE.mdの「実際のIndexedDB」の意図は何でしょうか？
   - `fake-indexeddb`を使わずに本物のブラウザIndexedDBでテストすることを意味しますか？
   - それとも、Dexie APIをモックせずに実際のDexie APIを使ってテストすることを意味しますか？（後者は既に実装済み）


2. 選択肢1〜3のどれを採用すべきでしょうか？
   - 現状のテストは既にDexieの実際のAPIを使用しており、fake-indexeddbは仕様準拠の実装を提供しています
   - E2Eテストに移行する必要がある場合、それは別の目的（統合テスト）になります

3. もし「実際のIndexedDB」が必須の場合、ユニットテストの範囲を超えるため、テストの目的と範囲を再定義する必要があると考えますが、いかがでしょうか？

### 回答：
するどいご指摘をありがとうございます。
意図としては、開発環境としても、IndexedDBが実際に使用されていることを確認したかったからでした。
背景としては、まだIndexedDBを導入したばかりで、ブランチのタイミングや、開発環境(WSL、CodeSpaces)によっては、IndexedDBが正しく動作しないことがあったためです。
実際には、make devの再実行、docker compose exec frontend npm run install で解決できるので大きな問題ではありません。
ただブランチをpullした直後に、e2eが失敗することが多く、原因の調査に時間がかかるため、ユニットテストの時点で検知したいという意図でした。

なのでテストコードを動かす環境で、IndexedDBが実際に使われていることがわかれば十分です。
その前提でなにかよい検知方法はあるでしょうか？

### 実装方針（回答を受けて）：

ユニットテストに以下の検証を追加します：

1. **IndexedDB環境検証テスト**
   - `globalThis.indexedDB`が正しく設定されているか確認
   - fake-indexeddbのIDBFactoryインスタンスであることを検証
   - Dexieデータベースが正常に初期化できることを確認

2. **既存テストの改善**
   - テストのbeforeEachで環境チェックを追加
   - IndexedDBが利用できない場合は明確なエラーメッセージを表示
   - 環境セットアップの問題を早期に検知

3. **メリット**
   - ブランチpull後、ユニットテスト実行時に環境問題を即座に検知
   - E2E失敗前にユニットテストレベルで問題を発見
   - 原因調査の時間を削減

# 残タスク
<!-- issueの進捗に応じて記入 -->
